# 分布式温控系统动态结构设计

2017211317 班 C 组

## 迭代历史

| 修改人   | 版本  | 描述                       |
| -------- | ----- | -------------------------- |
| 邱建鑫   | 1.0.0 | 发布文档                   |
| 邱建鑫   | 0.6.0 | 增加服务器调度交互过程设计 |
| 曾莉慧瑶 | 0.5.0 | 增加前台动态结构设计       |
| 赵子豪   | 0.4.0 | 增加住户动态结构设计       |
| 申茜     | 0.3.0 | 增加酒店经理动态结构设计   |
| 汪桐     | 0.2.0 | 增加管理员动态结构设计     |
| 邱建鑫   | 0.1.0 | 创建文档                   |

## 目录

[TOC]

## 住户动态结构设计

### 住户用例（使用空调）系统顺序图

![User](UseCase_user_graph.png)

### 操作契约

| 系统事件 | Power_On(roomID)                                                                                                                                                                                                                                     |
| -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 交叉引用 | 使用空调                                                                                                                                                                                                                                             |
| 前置条件 | 主控机对象 master 已经创建，并且 master 维护了一个 map 对象 slave_list（从控机信息表），在用户在前台办理入住时，就在 slave_list 中以 roomID 为键，创建了一个 slave 对象（从控机），并将 slave 的属性目标温度、风速设置为初始化值，计算并显示当前温度 |
| 后置条件 | 从控机开启                                                                                                                                                                                                                                           |

| 系统事件 | TemperatureChange(goal,roomID)                                 |
| -------- | -------------------------------------------------------------- |
| 交叉引用 | 使用空调                                                       |
| 前置条件 | 从控机开启                                                     |
| 后置条件 | 在 slave_list 中将对应房间的 slave 对象目标温度属性设置为 goal |

| 系统事件 | SpeedChange(goal,roomID)                                   |
| -------- | ---------------------------------------------------------- |
| 交叉引用 | 使用空调                                                   |
| 前置条件 | 从控机开启                                                 |
| 后置条件 | 在 slave_list 中将对应房间的 slave 对象风速属性设置为 goal |

| 系统事件 | show(goal_T,now_T,goal_S,now_S)                                                                                |
| -------- | -------------------------------------------------------------------------------------------------------------- |
| 交叉引用 | 使用空调                                                                                                       |
| 前置条件 | 从控机开启                                                                                                     |
| 后置条件 | 显示当前房间 slave 对象的目标温度和风速，计算并显示当前温度，并且将当前温度值赋值给 slave 对象中的当前温度属性 |

| 系统事件 | Power_Off(roomID)                                                |
| -------- | ---------------------------------------------------------------- |
| 交叉引用 | 使用空调                                                         |
| 前置条件 | 用户按下关机按钮                                                 |
| 后置条件 | 当前房间对应的 slave 对象中的当前温度、目标温度和风速设置为 null |

| 系统事件 | Close_Air_Conditioner            |
| -------- | -------------------------------- |
| 交叉引用 | 使用空调                         |
| 前置条件 | 空调已经关闭                     |
| 后置条件 | 不再显示当前温度、风速和目标温度 |

## 服务器调度交互过程设计

使用控制器模式，系统维护两个队列，分别为服务队列与等待队列。

### 具体调度过程

1. 控制器接收到客户端调风请求。检查服务队列 ServingQueue 是否有空位，如果 availible 则将服务对象推入服务队列，并返回 success；
2. 否则，进入**调度模式**。检查请求风速与服务队列中服务对象风速间的关系，
   1. 若高（higher），则进入**优先级调度**模式。正在服务的服务对象中选风速最低的放入等待队列；如果有多个风速相等，则找已服务时间最长的；
   2. 若相等或低（equal or lower），则放入**等待队列**，进入**时间片调度**模式。
3. **时间片调度**被实现为服务端的一个定时任务。调度器每隔一定的时间（s 秒）检查一遍队列，把服务队列中优先级最低的服务对象推入等待队列，并从等待队列中选取等待服务时间归零的房间推入服务队列，并主动通知从控机开机。
4. 在系统运行的过程中，如果有正在服务的从控机主动关机，则立即从等待队列中选取一个剩余时间最短的等待对象，并推入服务队列。

### 系统顺序图

![系统顺序图](schedule.svg)

## 酒店经理动态结构设计

### 登录系统用例

#### 控制器选择

由于系统用例较多，因此选择使用“用例控制器”，以登录控制器作为登录系统用例中的控制器。

#### 系统操作

| 操作名称                 | 操作说明 |
| ------------------------ | -------- |
| Login(username,password) | 登录系统 |

#### 具体设计

##### 操作契约

| 系统事件 | Login(username,password)               |
| -------- | -------------------------------------- |
| 交叉引用 | 登录系统                               |
| 前置条件 | 服务端处于开启且可用状态，且系统已打开 |
| 后置条件 | 1. 一个管理员实例被创建                |
|          | 2. 管理员的属性初始化                  |
|          | 3. 管理员实例与酒店建立"关联"          |

##### 交互图

| 操作名称                 | 功能                                                                  |
| ------------------------ | --------------------------------------------------------------------- |
| Login(username,password) | 输入用户名和密码，登录系统                                            |
| Check(username,password) | 查询管理员信息表，确认用户名和密码是否正确，并返回此管理员的信息 info |
| create(info)             | 用管理员的信息 info 创建此管理员的实例，并初始化此管理员实例          |
| add(m)                   | 将此管理员实例和酒店建立"关联"                                        |

![酒店经理动态结构设计-Login交互图](../img/dynamic_hotelManager_1.svg)

### 统计报表管理用例

#### 控制器选择

由于系统用例较多，因此选择使用“用例控制器”，以报表控制器作为统计报表管理用例中的控制器。

#### 系统操作

| 操作名称                     | 操作说明         |
| ---------------------------- | ---------------- |
| ViewReport()                 | 进入查看报表页面 |
| SetReportOption(type,period) | 设置报表参数     |
| PrintReport(ReportNo)        | 打印报表         |
| EndReport(ReportNo)          | 关闭报表         |

##### 操作契约

| 系统事件 | ViewReport()                                            |
| -------- | ------------------------------------------------------- |
| 交叉引用 | 查看报表                                                |
| 前置条件 | 酒店经理身份验证通过，开始查看报表                      |
| 后置条件 | 1. 一个报表实例建立                                     |
|          | 2. 报表实例与管理员实例建立“关联”                       |
|          | 3. 报表的属性初始化：报表号、建立时间、存储信息的数组等 |

##### 交互图

| 操作名称     | 功能                             |
| ------------ | -------------------------------- |
| ViewReport() | 进入查看报表页面                 |
| create()     | 创建报表实例并初始化             |
| add(r)       | 将报表实例与管理员实例建立“关联” |

![酒店经理动态结构设计-ViewReport交互图](../img/dynamic_hotelManager_2.svg)

##### 操作契约

| 系统事件 | SetReportOption(type,period)         |
| -------- | ------------------------------------ |
| 交叉引用 | 查看报表                             |
| 前置条件 | 酒店经理正在设置报表选项             |
| 后置条件 | 报表的属性被修改：report,type,period |

##### 交互图

| 操作名称                         | 功能                                                                                                                                                                                |
| -------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| SetReportOption(type,period)     | 设置报表参数                                                                                                                                                                        |
| getLog(type,period)              | 从日志中得到 period 时间段内的所有房间使用空调的记录 log 并返回                                                                                                                     |
| getBill(type,period)             | 从详单中得到 period 时间段内的所有房间的详单记录数和总费用 bill 并返回                                                                                                              |
| MakeReport(log,bill,type,period) | 根据设置参数 type，period 和从日志和详单中得到的数据 log 和 bill 生成报表，并返回生成的报表 report                                                                                  |
| changeAttri(bill,type,period)    | 修改报表的属性 type 和 period，同时将 bill 中的所有房间的详单记录数和总费用写入 report 中                                                                                           |
| Count(log,type)                  | 根据所选报表种类，统计日志中得到的 log 数据，得到报表。如当 type 为日报表时，则统计所有房间使用空调的次数，最常用目标温度，最常用风速，达到目标温度次数和被调度次数写入 report 中。 |
| DisplayReport(report)            | 打开报表显示页面，将 report 显示到屏幕上                                                                                                                                            |

![酒店经理动态结构设计-SetReportOption 交互图](../img/dynamic_hotelManager_3.svg)

##### 操作契约

| 系统事件 | PrintReport(ReportNo)                |
| -------- | ------------------------------------ |
| 交叉引用 | 查看报表                             |
| 前置条件 | 酒店经理正在查看报表，并选择打印报表 |
| 后置条件 | 报表属性被修改：isPrinted            |

##### 交互图

| 操作名称              | 功能                                     |
| --------------------- | ---------------------------------------- |
| PrintReport(ReportNo) | 打印报表号为 ReportNo 的报表             |
| getReport(ReportNo)   | 获得报表号为 ReportNo 的报表的信息并返回 |
| isPrinted()           | 将 isPrinted 属性修改为 1                |
| print(ReportNo)       | 向打印机发起打印报表 report 的请求       |

![酒店经理动态结构设计-PrintReport交互图](../img/dynamic_hotelManager_4.svg)

##### 操作契约

| 系统事件 | EndReport(ReportNo)                  |
| -------- | ------------------------------------ |
| 交叉引用 | 查看报表                             |
| 前置条件 | 酒店经理完成查看报表，并选择关闭报表 |
| 后置条件 | 1. 报表实例与酒店建立“关联”          |
|          | 2. 报表属性被修改：isViewed          |

##### 交互图

| 操作名称                | 功能                       |
| ----------------------- | -------------------------- |
| EndReport(ReportNo)     | 关闭报表                   |
| ConcealReport(ReportNo) | 关闭报表页面               |
| isViewed()              | 将 isViewed 属性修改为 1   |
| add(r)                  | 将报表实例与酒店建立“关联” |

![酒店经理动态结构设计-EndReport交互图](../img/dynamic_hotelManager_5.svg)

## 管理员动态结构设计

### 系统操作

| 操作名称                                                                                                               | 操作说明                                                                                                                                                       |
| ---------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Login(ID:string,pwd:string)                                                                                            | 登录系统                                                                                                                                                       |
| InitializationMode(mode:boolen,scope:{"min":interger, "max": interger},defluat:interger,rate:interger,object:interger) | 管理员对主控机初始化，设置基础参数，分别为温控模式（冷或热）、设置温控范围（18-26/26-30 度）、缺省温度（26 度）、费率（3/2/1）以及服务对象（假设服务对象数=3） |
| SetMode(mode:boolen,scope:{"min":interger, "max": interger},defluat:interger,rate:interger,object:interger)            | 管理员改变主控机当前的运行配置                                                                                                                                 |
| GetRoomInformation()                                                                                                   | 获取所有房间状态信息，默认每分钟刷新一次                                                                                                                       |
| GetInformation(roomID:int)                                                                                             | 获取指定从控机详细信息，默认每分钟刷新一次                                                                                                                     |
| Quit()                                                                                                                 | 退出系统                                                                                                                                                       |

### 操作契约

| 系统事件 | Login(role:string,ID:string,pwd:string),登录系统 |
| -------- | ------------------------------------------------ |
| 交叉引用 | 切换运行状态 Manager_001                         |
| 前置条件 | 无                                               |
| 后置条件 | 1.管理员与主控机建立关联                         |
|          | 2.管理员与主控机状态切换界面建立关联             |

| 事件名称                     | 功能                                                      |
| ---------------------------- | --------------------------------------------------------- |
| Logoninterface()             | 管理员进入登录界面                                        |
| Staff=Authentication(ID,pwd) | 进行身份验证，返回值 staff 为布尔变量，参数为用户名及密码 |

![](https://github.com/Seyuko/Pictures/blob/master/manager-dynamic-1.png?raw=true)

| 系统事件 | InitializationMode(mode:boolen,scope:{"min":interger, "max": interger},defluat:interger,rate:interger,object:interger),主控机配置初始化 |
| -------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| 交叉引用 | 主控机开机 Manager_001_1                                                                                                                |
| 前置条件 | 主控机开机                                                                                                                              |
| 后置条件 | 主控机配置设定完成，初始化完成                                                                                                          |

| 事件名称                                      | 功能                                                                                       |
| --------------------------------------------- | ------------------------------------------------------------------------------------------ |
| Operateinterface()                            | 管理员进入管理员操作面板                                                                   |
| Setupinterface()                              | 管理员进入主控机设置面板                                                                   |
| Parameterset(mode,scope,defluat,rate,object） | 管理员对主控机进行初始化，设置基础参数，参数分别为温控模式，范围，缺省温度，费率，服务对象 |

![](https://github.com/Seyuko/Pictures/blob/master/manager-dynamic-2.png?raw=true)

| 系统事件 | SetMode(mode:boolen,scope:{"min":interger, "max": interger},defluat:interger,rate:interger,object:interger),改变主控机当前配置 |
| -------- | ------------------------------------------------------------------------------------------------------------------------------ |
| 交叉引用 | 更改运行配置 Manager_002                                                                                                       |
| 前置条件 | 主控机开启                                                                                                                     |
| 后置条件 | 主控机运行配置改变                                                                                                             |

| 事件名称                                 | 功能                                                                           |
| ---------------------------------------- | ------------------------------------------------------------------------------ |
| Operateinterface()                       | 管理员进入管理员操作面板                                                       |
| Setupinterface()                         | 管理员进入主控机设置面板                                                       |
| SetMode(mode,scope,defluat,rate,object） | 管理员对主控机设置进行更改，参数分别为温控模式，范围，缺省温度，费率，服务对象 |

![用例图](https://github.com/Seyuko/Pictures/blob/master/manager-dynamic-3.png?raw=true)

| 系统事件 | GetRoomInformation(),获取各房间信息 |
| -------- | ----------------------------------- |
| 交叉引用 | 监控运行状态 Manager_003            |
| 前置条件 | 主控机开启                          |
| 后置条件 | 管理员获取所有房间的状态信息        |

| 事件名称             | 功能                                                       |
| -------------------- | ---------------------------------------------------------- |
| Operateinterface()   | 管理员进入管理员操作面板                                   |
| Querypanel()         | 管理员进入主控机信息查看面板                               |
| GetRoomInformation() | 主控机获取所有房间的状态信息，按刷新频率（一分钟）进行更新 |

![用例图](https://github.com/Seyuko/Pictures/blob/master/manager-dynamic-4.png?raw=true)

| 系统事件 | GetInformation(roomID:int),获取指定从控机详细信息 |
| -------- | ------------------------------------------------- |
| 交叉引用 | 监控运行状态 Manager_003                          |
| 前置条件 | 主控机开启，管理员使用主控机                      |
| 后置条件 | 管理员获取指定从控机详细信息                      |

| 事件名称                      | 功能                                                                   |
| ----------------------------- | ---------------------------------------------------------------------- |
| Operateinterface()            | 管理员进入管理员操作面板                                               |
| Querypanel()                  | 管理员进入主控机设置面板                                               |
| Inform=Getinformation(roomID) | 获取从控机工作信息，按刷新频率（一分钟）进行更新，参数为被检测的房间号 |

![用例图](https://github.com/Seyuko/Pictures/blob/master/manager-dynamic-5.png?raw=true)

| 系统事件 | Quit(),退出系统          |
| -------- | ------------------------ |
| 交叉引用 | 切换运行状态 Manager_001 |
| 前置条件 | 主控机开启               |
| 后置条件 | 主控机关闭               |

## 前台动态结构设计

| 系统事件 | 获取用户状态               |
| -------- | -------------------------- |
| 交叉引用 | 创建详单用例               |
| 前置条件 | 主，从控机正常运行         |
| 后置条件 | 1.用户状态被创建           |
|          | 2.用户状态与前台服务员关联 |

| 操作名称                 | 操作说明                                     |
| ------------------------ | -------------------------------------------- |
| AskUserState(roomID:int) | 前台服务员向系统请求房间状态；参数为房间号； |
| GiveRoomid（roomID:int） | 主控机将房间号传送给从控机；参数为房间号     |
| UserStateReq（）         | 从控机请求获取房间状态                       |
| ReqStart（）             | 开始请求获取用户状态                         |
| GiveUserState（）        | 返回用户状态                                 |

![YWwy3q.png](https://s1.ax1x.com/2020/05/18/YWwy3q.png)

| 系统事件 | 获取个人账单               |
| -------- | -------------------------- |
| 交叉引用 | 切换运行状态 Manager_001   |
| 前置条件 | 已获取用户状态             |
| 后置条件 | 1.个人账单被创建           |
|          | 2.个人账单与前台服务员关联 |

| 事件名称                | 功能                                         |
| ----------------------- | -------------------------------------------- |
| AskForBill(roomID:int)  | 前台服务员向系统请求个人账单；参数为房间号； |
| GiveRoomid（roomID:int) | 主控机将房间号传送给从控机；参数为用户房间号 |
| BillReq（roomID:int）   | 从控机请求获取个人账单                       |

![YW0Lzq.png](https://s1.ax1x.com/2020/05/18/YW0Lzq.png)

| 系统事件 | PrintBill()            |
| -------- | ---------------------- |
| 交叉引用 | 打印账单               |
| 前置条件 | 住户办理退房业务       |
| 后置条件 | 1.新账单被创建         |
|          | 2.账单与前台建立“关联” |
|          | 3.账单属性初始化       |

| 事件名称                | 功能                                         |
| ----------------------- | -------------------------------------------- |
| AskForBill(roomID:int)  | 前台服务员向系统请求个人账单；参数为房间号； |
| GiveRoomid（roomID:int) | 主控机将房间号传送给从控机；参数为用户房间号 |
| BillReq（roomID:int）   | 从控机请求获取个人账单                       |
| printBill（）           | 打印获得的账单                               |

![YWBt0S.png](https://s1.ax1x.com/2020/05/18/YWBt0S.png)

| 系统事件 | AskforConsume()                  |
| -------- | -------------------------------- |
| 交叉引用 | 查看消费信息                     |
| 前置条件 | 经理向前台申请查看各房间消费记录 |
| 后置条件 | 1.新查询结果被创建               |
|          | 2.经理与前台建立“关联”           |
|          | 3.前台与系统建立“关联”           |

| 事件名称                 | 功能                                         |
| ------------------------ | -------------------------------------------- |
| AskForBill(roomID:int)   | 前台服务员向系统请求个人账单；参数为房间号； |
| GiveRoomid（roomID:int)  | 主控机将房间号传送给从控机；参数为用户房间号 |
| ConsumeReq（roomID:int） | 从控机请求获取个人账单                       |
| ReturnCon（roomID:int）  | 打印获得的账单                               |

[![YW6jyR.png](https://s1.ax1x.com/2020/05/18/YW6jyR.png)](https://imgchr.com/i/YW6jyR)
